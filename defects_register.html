<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>不良品登録（タブレット）</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />

    <style>
      :root {
        --row-col-width: 80px;
        --action-col-width: 88px;
      }

      body {
        background: var(--bs-body-bg);
      }

      .page {
        padding-bottom: 132px;
      }

      .table-responsive {
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }

      #defectsTable th,
      #defectsTable td {
        vertical-align: middle;
      }

      .col-no {
        width: var(--row-col-width);
      }

      .col-action {
        width: var(--action-col-width);
      }

      .defects-input {
        font-variant-numeric: tabular-nums;
      }

      .bottom-bar {
        padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        background: rgba(var(--bs-body-bg-rgb), 0.96);
        backdrop-filter: blur(10px);
      }
    </style>
  </head>

  <body>
    <main class="container-fluid page py-3 px-3 px-md-4">
      <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-3">
        <div>
          <h1 class="h3 mb-1">不良品登録</h1>
          <div class="text-secondary">不良品数を入力します（0.1刻み）</div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary btn-lg" id="addRowBtn" type="button">＋ 行追加</button>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-bordered mb-0 align-middle" id="defectsTable">
              <thead>
                <tr>
                  <th class="text-center col-no">No.</th>
                  <th class="text-center">不良品数</th>
                  <th class="text-center col-action">操作</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <div class="fixed-bottom border-top bottom-bar">
      <div class="container-fluid py-3 px-3 px-md-4">
        <button class="btn btn-primary btn-lg w-100 py-3" id="submitBtn" type="button">送信</button>
        <div class="small text-secondary mt-2 text-center" id="statusText"></div>
      </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div
        aria-atomic="true"
        aria-live="assertive"
        class="toast text-bg-primary border-0"
        id="appToast"
        role="alert"
      >
        <div class="d-flex">
          <div class="toast-body" id="toastBody"></div>
          <button
            aria-label="閉じる"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            type="button"
          ></button>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      const apiBaseParam = new URLSearchParams(window.location.search).get('apiBase')?.trim()
      const API_BASE =
        apiBaseParam ?? (window.location.protocol === 'file:' ? 'http://localhost:3000' : '')

      const jwtParam = new URLSearchParams(window.location.search).get('jwt')?.trim()
      let jwt = ''
      try {
        if (jwtParam) {
          jwt = jwtParam
          window.localStorage?.setItem('workez_jwt', jwtParam)
        } else {
          jwt = window.localStorage?.getItem('workez_jwt')?.trim() || ''
        }
      } catch {
        jwt = jwtParam || ''
      }

      const AUTH_HEADER = jwt
        ? { Authorization: jwt.startsWith('Bearer ') ? jwt : `Bearer ${jwt}` }
        : {}

      const state = {
        rows: [{ id: 'row-1', count: '' }],
      }

      const els = {
        addRowBtn: document.getElementById('addRowBtn'),
        submitBtn: document.getElementById('submitBtn'),
        tableBody: document.getElementById('tableBody'),
        statusText: document.getElementById('statusText'),
        toastEl: document.getElementById('appToast'),
        toastBody: document.getElementById('toastBody'),
      }

      const toast = window.bootstrap ? window.bootstrap.Toast.getOrCreateInstance(els.toastEl) : null

      function setStatus(text) {
        els.statusText.textContent = text || ''
      }

      function showToast(message, variant = 'primary') {
        if (!els.toastEl || !els.toastBody) return

        els.toastEl.classList.remove('text-bg-primary', 'text-bg-success', 'text-bg-danger', 'text-bg-warning')
        els.toastEl.classList.add(`text-bg-${variant}`)
        els.toastBody.textContent = message

        if (toast) toast.show()
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;')
      }

      function generateEventId() {
        if (window.crypto?.randomUUID) return window.crypto.randomUUID()
        return `defects-${Date.now()}-${Math.random().toString(16).slice(2)}`
      }

      function render() {
        const rows = state.rows
          .map((row, index) => {
            const removeDisabled = state.rows.length <= 1 ? 'disabled' : ''
            return `
              <tr>
                <th class="text-center col-no">${index + 1}</th>
                <td>
                  <input
                    class="form-control form-control-lg text-end defects-input"
                    type="number"
                    inputmode="decimal"
                    min="0.1"
                    step="0.1"
                    placeholder=""
                    autocomplete="off"
                    data-row-id="${escapeHtml(row.id)}"
                    aria-label="不良品数（0.1刻み）"
                    value="${escapeHtml(row.count)}"
                  />
                </td>
                <td class="text-center col-action">
                  <button
                    class="btn btn-outline-danger btn-sm px-2 py-0 remove-row"
                    type="button"
                    data-row-id="${escapeHtml(row.id)}"
                    aria-label="行を削除"
                    ${removeDisabled}
                  >
                    ×
                  </button>
                </td>
              </tr>
            `
          })
          .join('')

        els.tableBody.innerHTML = rows
      }

      function addRow() {
        const id = `row-${Date.now()}-${Math.random().toString(16).slice(2)}`
        state.rows.push({ id, count: '' })
        render()
      }

      function removeRow(rowId) {
        if (state.rows.length <= 1) return
        state.rows = state.rows.filter((row) => row.id !== rowId)
        render()
      }

      function setValue(rowId, value) {
        const row = state.rows.find((r) => r.id === rowId)
        if (!row) return
        row.count = value
      }

      function normalizeCount(raw) {
        const value = Number.parseFloat(raw)
        if (!Number.isFinite(value)) return { ok: false, message: '入力値（不良品数）が不正です。' }
        if (value < 0.1) return { ok: false, message: '不良品数は0.1以上で入力してください。' }
        const rounded = Math.round(value * 10) / 10
        if (Math.abs(rounded - value) > 1e-9) {
          return { ok: false, message: '不良品数は0.1刻みで入力してください。' }
        }
        return { ok: true, value: rounded }
      }

      function collectEntries() {
        const entries = []
        for (const row of state.rows) {
          const raw = row.count?.trim()
          if (!raw) continue
          const normalized = normalizeCount(raw)
          if (!normalized.ok) return normalized
          entries.push({ event_id: generateEventId(), count: normalized.value })
        }
        if (entries.length === 0) return { ok: false, message: '入力がありません。' }
        return { ok: true, entries }
      }

      async function submitAll() {
        const result = collectEntries()
        if (!result.ok) {
          showToast(result.message, 'danger')
          return
        }

        const entries = result.entries
        els.submitBtn.disabled = true
        setStatus(`送信中…（${entries.length}件）`)

        const results = await Promise.allSettled(
          entries.map(async (entry) => {
            const url = new URL(`${API_BASE}/defects/amount/add`, window.location.href)
            const res = await fetch(url.toString(), {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', ...AUTH_HEADER },
              body: JSON.stringify(entry),
            })

            if (!res.ok) {
              const text = await res.text().catch(() => '')
              throw new Error(`${res.status} ${res.statusText}${text ? `: ${text}` : ''}`)
            }

            return true
          })
        )

        const okCount = results.filter((r) => r.status === 'fulfilled').length
        const ngCount = results.length - okCount

        if (ngCount === 0) {
          showToast(`送信しました（${okCount}件）`, 'success')
          setStatus('')
        } else {
          showToast(`一部失敗しました（成功${okCount}件 / 失敗${ngCount}件）`, 'danger')
          setStatus('API未実装/接続不可の場合は、送信先の実装後に再送してください。')
          console.error('Submit errors:', results)
        }

        els.submitBtn.disabled = false
      }

      function wireEvents() {
        els.addRowBtn.addEventListener('click', () => addRow())
        els.submitBtn.addEventListener('click', () => submitAll())

        document.addEventListener('input', (event) => {
          const target = event.target
          if (!(target instanceof HTMLElement)) return
          if (!target.classList.contains('defects-input')) return
          const rowId = target.getAttribute('data-row-id')
          if (!rowId) return
          setValue(rowId, target.value.trim())
        })

        document.addEventListener('click', (event) => {
          const target = event.target
          if (!(target instanceof HTMLElement)) return
          if (!target.classList.contains('remove-row')) return
          const rowId = target.getAttribute('data-row-id')
          if (!rowId) return
          removeRow(rowId)
        })
      }

      function init() {
        render()
        wireEvents()
      }

      init()
    </script>
  </body>
</html>

