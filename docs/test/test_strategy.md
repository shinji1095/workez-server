# テスト戦略（TBD）

## 1. 目的
- API仕様（docs/api/openapi.yaml）に対して、実装が仕様に一致していることを継続的に検証する。
- 変更が入った際に、主要機能（ユーザー/デバイス/収穫/売上/不良品）の回帰を検出する。
- 本番環境のデータを汚さない形でE2E確認（curl）を行えるようにする。

出典：
- エンドポイント定義は CSV（01_WEB機能一覧(機能一覧).csv）に基づく。
- 入出力・認証の詳細はCSVに無いため、本戦略ではTBDとして扱う。

## 2. テストの層（Unit / Integration / E2E(curl)）
- Unit（単体）
  - 関数/モジュール単位でロジックを検証（例：バリデーション、集計ロジック、変換）。
  - DB/外部I/Oはモック化（方式はTBD）。
- Integration（結合）
  - APIハンドラ + DB を含めた結合検証。
  - OpenAPIで定義したステータスコードと共通エラー形式（ErrorResponse）を中心に検証。
- E2E(curl)
  - 実行環境に対してcurl等でHTTPリクエストを投げ、仕様に沿ったレスポンスを確認。
  - デプロイ後の疎通確認、運用手順（runbook）と直結。

## 3. 対象範囲（どのディレクトリがどの層か）
以下は「想定」のフォルダ構成（実装が未確定/未整備の場合はTBD）。

- Unit：`tests/unit/`（想定）
- Integration：`tests/integration/`（想定）
- E2E：`e2e/`（想定）
- テストデータ（fixture等）：`tests/fixtures/`（想定）

実際のリポジトリ構成に合わせて、ディレクトリは調整する（TBD）。

## 4. 実行順序（Unit→Integration→E2E）
1) Unit を先に実行して、ロジック単体の破壊を最速で検出する  
2) Integration を実行して、APIとDBの整合を確認する  
3) 最後に E2E を実行して、環境差分（設定/ネットワーク/デプロイ）を確認する

## 5. 品質ゲート（合格条件）
- Unit：全テスト成功、主要モジュールの最低限のカバレッジ（閾値はTBD）
- Integration：
  - 主要エンドポイントで 200/201 が返ること（仕様に基づく）
  - 4xx/5xx が共通エラー形式（ErrorResponse）で返ること
- E2E：
  - `GET /users` 等の代表疎通が成功すること（認証が必要な場合の手順はTBD）
  - レスポンスがJSONであること
  - 実行が「コマンド一発」で可能なこと（runbookに記載）

## 6. テストデータ規約（E2Eで本番DBを汚さないルール、識別子prefix等）
- 本番環境への書き込みを伴うE2Eは原則禁止（許可する場合は明確な隔離が必要、TBD）
- ローカル/検証環境で書き込みテストを行う場合：
  - テストデータには識別子prefixを付与する（例：`e2e_`、`test_` など。具体ルールはTBD）
  - 作成したデータはテスト終了時に削除する（削除APIが無い場合の扱いはTBD）
- Device送信系（収穫量/不良品数等）は二重送信があり得るため、冪等性（event_id等）の導入を検討する（TBD）

## 7. 失敗時の切り分け手順
1) OpenAPI（docs/api/openapi.yaml）と実装の差分を確認（パス/メソッド/ステータスコード）  
2) ErrorResponse形式（error.code, error.message, error.details, error.request_id）が返っているか確認  
3) Integration失敗の場合：DB接続/マイグレーション/シードの状態を確認（手順はTBD）  
4) E2E失敗の場合：BASE_URL、環境変数、認証情報（トークン/キー）が正しいか確認（TBD）  
5) それでも不明な場合：サーバーログと request_id を突き合わせて原因箇所を特定（request_id生成はTBD）
