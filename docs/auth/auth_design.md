# 認証・認可 設計（TBD）

## 1. 背景と目的
本システムは、椎茸の収穫数をITデバイスで自動集計し、Webで可視化することを目的とする。
本ドキュメントは、プロジェクト内CSV（01_WEB機能一覧(機能一覧).csv）に記載されたAPIエンドポイント群に対し、認証・認可（権限管理）の設計方針を整理する。

注意：
- CSVには「認証方式」や「トークン形態」の確定情報が無いため、ここでは候補提示に留め、採用決定は行わない（TBD）。
- 認証が未確定のため、OpenAPI（docs/api/openapi.yaml）には security 定義を付与していない（ルール準拠）。

## 2. アクター定義（TBD）
本ドキュメントでは便宜上、以下のロールを定義する（実ロール体系はTBD）。

- Device：収穫量/不良品数/バッテリー状態/故障アラーム等を送信するITデバイス
- Admin：管理機能（ユーザー管理、デバイス管理、目標設定、単価設定、売上/予測など）を扱う管理者
- Viewer：閲覧系（収穫量推移、デバイス状態の確認等）を行う一般利用者

ロールと各エンドポイントの許可関係は docs/auth/permission_matrix.csv を正とする。

## 3. 認証方式の候補（少なくとも2案、採用決定はしない）
CSVには認証方式の確定情報が無いため、以下は候補であり、採用はTBD。

### 案A：管理者/一般＝JWT、デバイス＝API Key
- Admin/Viewer：Authorization: Bearer <JWT>
- Device：X-API-Key: <device_api_key>（または Authorization: ApiKey <...>）
- 利点：実装・運用が比較的単純。デバイスは鍵のローテーションが容易。
- 懸念：デバイスキー漏洩時の影響範囲（レート制限、失効手段、端末紐付けが必要）。JWTの失効戦略はTBD。

### 案B：管理者/一般＝セッション（Cookie）、デバイス＝署名付きトークン（短命）
- Admin/Viewer：HTTPS + HttpOnly Cookie（セッションID）
- Device：短命トークン（署名付きJWT等）を発行し定期更新（発行/更新APIはTBD）
- 利点：Web側の運用が分かりやすい。デバイス側は短命トークンでリスク低減可能。
- 懸念：トークン発行/更新の仕組みが追加で必要。デバイスの初期登録・鍵配布フローはTBD。

（補足）上記以外にも、mTLS等の案はあり得るが、CSVに根拠が無いため本資料では列挙に留める（TBD）。

## 4. 認可（権限）設計方針
- エンドポイント単位で「許可/拒否」を明確化する。
- 権限の一次情報は CSV の「権限」列および「説明」列の文言であり、推測は最小限にする。
- 権限表（docs/auth/permission_matrix.csv）を正とし、実装時はこの表を参照してミドルウェア/ガードを実装する（実装は本タスク範囲外）。

## 5. 秘密情報の管理（TBD）
- すべて環境変数で管理する（例：JWT_SECRET, DEVICE_API_KEY_SALT 等）。具体名はTBD。
- デプロイ環境として Render を想定し、Renderの Environment Variables に格納する（運用詳細はTBD）。
- リポジトリへの平文コミットは禁止（.env は gitignore）。

## 6. 監査ログ・レート制限・冪等性（TBD）
- 監査ログ：
  - Admin操作（ユーザー削除、単価変更、目標設定 等）について、誰がいつ何をしたかを記録する（形式/保管先はTBD）。
- レート制限：
  - Device送信系（収穫量/不良品数/バッテリー/アラーム）は過負荷防止のためレート制限を検討（閾値はTBD）。
- 冪等性：
  - Device送信系は二重送信の可能性を考慮し、event_id 等の冪等キー導入を検討（有無・仕様はTBD）。

## 7. 未決事項（TBD一覧）
- 認証方式の採用決定（案A/案B/その他）
- トークン/キーの配布・更新・失効フロー
- ロール体系（Admin/Viewerの階層関係が「≧」で示唆されるが、厳密仕様はTBD）
- 401/403の使い分け、エラーコード体系（ErrorResponse.code の定義）
- request_id の生成方法とログ相関
- レート制限の方式/閾値
- 冪等性キーの導入有無と保存期間
