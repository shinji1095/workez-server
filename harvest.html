<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta charset="UTF-8" />
  <title>IoT Harvest Management</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

  <!-- Top Bar -->
  <header class="topbar">
    <div class="logo">Logo</div>
    <div class="top-actions">
      <button>Profile</button>
      <button>Logout</button>
    </div>
  </header>

  <div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
      <a href="index.html" class="nav-btn">Dashboard</a>
      <a href="devices.html" class="nav-btn">Devices</a>
      <a href="harvest.html" class="nav-btn active">Harvest</a>
      <a href="revenue.html" class="nav-btn">Revenue</a>
      <a href="defects.html" class="nav-btn">Defects</a>
      <a href="users.html" class="nav-btn">Users</a>
      <a href="targets.html" class="nav-btn">Targets</a>
      <a href="analytics.html" class="nav-btn">Analytics</a>
    </aside>


    <!-- Main Content -->
    <main class="content">

      <!-- Period Selector -->
      <div class="period">
        <button type="button" onclick="loadPeriod(event, 'daily')">Daily</button>
        <button type="button" onclick="loadPeriod(event, 'weekly')">Weekly</button>
        <button type="button" onclick="loadPeriod(event, 'monthly')">Monthly</button>
      </div>

      <!-- Harvest Amount -->
      <section class="card">
        <h3>Harvest Amount</h3>
        <canvas id="harvestChart"></canvas>
      </section>

      <!-- Category / Size -->
      <section class="category">
        <span>Category / Size</span>
          <button type="button" onclick="loadCategory(event, 'all')">All</button>
          <button type="button" onclick="loadCategory(event, 1)">Large</button>
          <button type="button" onclick="loadCategory(event, 2)">Medium</button>
          <button type="button" onclick="loadCategory(event, 3)">Small</button>

        <p class="note">Note: Category values editable by Admin</p>
      </section>

      <!-- Bottom Charts -->
      <section class="grid-2">
        <div class="card">
          <h3>Defect Count</h3>
          <canvas id="defectCountChart"></canvas>
        </div>
        <div class="card">
          <h3>Defect Ratio</h3>
          <canvas id="defectRatioChart"></canvas>
        </div>

      </section>

    </main>
  </div>
  <script>
/* =========================
   HELPERS
========================= */
function lockScroll(asyncFn) {
  const scrollY = window.scrollY;
  return Promise.resolve(asyncFn()).finally(() => {
    requestAnimationFrame(() => {
      window.scrollTo({ top: scrollY });
    });
  });
}

Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = true;
Chart.defaults.animation = false;



const API_BASE = "http://localhost:3000/harvest";
/* =========================
   COLOR CONFIG
========================= */

// Period-based colors
const PERIOD_COLORS = {
  daily: "rgba(54, 162, 235, 0.7)",    // blue
  weekly: "rgba(75, 192, 192, 0.7)",   // green
  monthly: "rgba(255, 159, 64, 0.7)"   // orange
};

// Category-based colors
const CATEGORY_COLORS = {
  all: "rgba(153, 102, 255, 0.7)",     // purple
  1: "rgba(255, 99, 132, 0.7)",        // red (Large)
  2: "rgba(255, 206, 86, 0.7)",        // yellow (Medium)
  3: "rgba(54, 162, 235, 0.7)"          // blue (Small)
};

// Defect charts
const DEFECT_COUNT_COLOR = "rgba(201, 203, 207, 0.7)";
const DEFECT_RATIO_COLOR = "rgba(255, 99, 132, 0.7)";


let currentPeriod = "daily";
let currentCategory = "all";

let harvestChart, defectCountChart, defectRatioChart;

async function fetchHarvest() {
  if (currentCategory === "all") {
    const res = await fetch(
      `${API_BASE}/amount/${currentPeriod}/all`
    );
    return res.json();
  } else {
    const res = await fetch(
      `${API_BASE}/amount/${currentPeriod}/category/${currentCategory}`
    );
    return res.json();
  }
}


async function fetchDefects() {
  if (currentCategory === "all") {
    const res = await fetch(
      `${API_BASE}/defects/${currentPeriod}/all`
    );
    return res.json();
  } else {
    const res = await fetch(
      `${API_BASE}/defects/${currentPeriod}/category/${currentCategory}`
    );
    return res.json();
  }
}


async function loadCategory(event, category) {
  event.preventDefault();          
  event.stopPropagation();       
  currentCategory = category;
  await lockScroll(renderAll);
}

async function loadPeriod(event, period) {
  event.preventDefault();
  event.stopPropagation();

  currentPeriod = period;
  await lockScroll(renderAll);
}


/* =========================
   RENDER ALL CHARTS
========================= */

async function renderAll() {
  const [harvest, defects] = await Promise.all([
    fetchHarvest(),
    fetchDefects()
  ]);

  renderHarvestChart(harvest);
  renderDefectCharts(defects);
}

/* =========================
   HARVEST CHART
========================= */
function renderHarvestChart(data) {

  if (harvestChart) harvestChart.destroy();

  let labels = [];
  let datasets = [];

  const labelPrefix =
    currentPeriod === "daily" ? "Day" :
    currentPeriod === "weekly" ? "Week" :
    "Month";

  if (currentCategory === "all") {
    const length = data.large.length;
    labels = Array.from({ length }, (_, i) => `${labelPrefix} ${i + 1}`);

    datasets = [
      {
        label: "Large",
        data: data.large.map(d => d.amount),
        backgroundColor: CATEGORY_COLORS[1]
      },
      {
        label: "Medium",
        data: data.medium.map(d => d.amount),
        backgroundColor: CATEGORY_COLORS[2]
      },
      {
        label: "Small",
        data: data.small.map(d => d.amount),
        backgroundColor: CATEGORY_COLORS[3]
      }
    ];
  } else {
    labels = data.map((_, i) => `${labelPrefix} ${i + 1}`);
    datasets = [{
      data: data.map(d => d.amount),
      backgroundColor: CATEGORY_COLORS[currentCategory]
    }];
  }

harvestChart = new Chart(document.getElementById("harvestChart"), {
  type: "bar",
  data: { labels, datasets },
  options: {
    responsive: true,
    plugins: {
      legend: { display: currentCategory === "all" }
    },
    scales: {
      x: { stacked: currentCategory === "all" },
      y: { stacked: currentCategory === "all", beginAtZero: true }
    },

    onClick: (evt, elements) => {
      if (!elements.length) return;

      const el = elements[0];
      const dataIndex = el.index;
      const datasetIndex = el.datasetIndex;

      let categoryToEdit = currentCategory;

      // If stacked ("all"), determine which category was clicked
      if (currentCategory === "all") {
        categoryToEdit =
          datasetIndex === 0 ? 1 :
          datasetIndex === 1 ? 2 :
          3;
      }

      const oldValue =
        harvestChart.data.datasets[datasetIndex].data[dataIndex];

      const newValue = prompt(
        `Edit value (${currentPeriod}, category ${categoryToEdit})`,
        oldValue
      );

      if (newValue === null) return;

      updateHarvestValueByChart(categoryToEdit, dataIndex, Number(newValue));
    }
  }
});

}


/* =========================
   DEFECT CHARTS
========================= */

function renderDefectCharts(data) {

  if (defectCountChart) defectCountChart.destroy();
  if (defectRatioChart) defectRatioChart.destroy();

  const labelPrefix =
    currentPeriod === "daily" ? "Day" :
    currentPeriod === "weekly" ? "Week" :
    "Month";

  let labels = [];
  let countDatasets = [];
  let ratioDatasets = [];

  /* =========================
     ALL (STACKED)
  ========================= */
  if (currentCategory === "all") {
    const length = data.large.length;
    labels = Array.from({ length }, (_, i) => `${labelPrefix} ${i + 1}`);

    countDatasets = [
      {
        label: "Large",
        data: data.large.map(d => d.count),
        backgroundColor: CATEGORY_COLORS[1]
      },
      {
        label: "Medium",
        data: data.medium.map(d => d.count),
        backgroundColor: CATEGORY_COLORS[2]
      },
      {
        label: "Small",
        data: data.small.map(d => d.count),
        backgroundColor: CATEGORY_COLORS[3]
      }
    ];

    ratioDatasets = [
      {
        label: "Large",
        data: data.large.map(d => d.ratio),
        borderColor: CATEGORY_COLORS[1],
        backgroundColor: CATEGORY_COLORS[1],
        tension: 0.3
      },
      {
        label: "Medium",
        data: data.medium.map(d => d.ratio),
        borderColor: CATEGORY_COLORS[2],
        backgroundColor: CATEGORY_COLORS[2],
        tension: 0.3
      },
      {
        label: "Small",
        data: data.small.map(d => d.ratio),
        borderColor: CATEGORY_COLORS[3],
        backgroundColor: CATEGORY_COLORS[3],
        tension: 0.3
      }
    ];
  }

  /* =========================
     SINGLE CATEGORY
  ========================= */
  else {
    labels = data.map((_, i) => `${labelPrefix} ${i + 1}`);

    countDatasets = [{
      data: data.map(d => d.count),
      backgroundColor: CATEGORY_COLORS[currentCategory]
    }];

    ratioDatasets = [{
      data: data.map(d => d.ratio),
      borderColor: CATEGORY_COLORS[currentCategory],
      backgroundColor: CATEGORY_COLORS[currentCategory],
      tension: 0.3
    }];
  }

  /* =========================
     DEFECT COUNT
  ========================= */
  defectCountChart = new Chart(
    document.getElementById("defectCountChart"),
    {
      type: "bar",
      data: { labels, datasets: countDatasets },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: currentCategory === "all" }
        },
        scales: {
          x: { stacked: currentCategory === "all" },
          y: { stacked: currentCategory === "all", beginAtZero: true }
        }
      }
    }
  );

  /* =========================
     DEFECT RATIO
  ========================= */
  defectRatioChart = new Chart(
    document.getElementById("defectRatioChart"),
    {
      type: "line",
      data: { labels, datasets: ratioDatasets },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { display: currentCategory === "all" }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 1
          }
        }
      }
    }
  );
/* =========================
   EDIT CHARTS
========================= */

async function updateHarvestValueByChart(category, index, value) {
  await fetch(
    `${API_BASE}/amount/${currentPeriod}/category/${category}`,
    {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ index, value })
    }
  );

  await lockScroll(renderAll);
}

}renderAll();
</script>

</body>
</html>
